# L1J-Rust

Lineage 1（3.80c 台灣版）遊戲伺服器，使用 **Rust** 開發。

本專案為 **L1J-TW Java 伺服器的完整重寫版本**，以極致效能為目標設計 —— 能在畫面中同時處理 **10,000+ NPC** 而不產生延遲。

---

## 功能特色

### Networking（網路）
- Tokio 非同步 TCP 監聽（非阻塞 I/O）
- XOR Cipher 加密（完整 1:1 移植自 Java `Cipher.java`）
- 封包框架（2-byte Little Endian 長度標頭）
- 完整支援 3.80c 台灣版協定（250+ Opcode）
- Big5 / MS950 中文編碼顯示

### Login System（登入系統）
- 帳號驗證（SHA-1 + Base64，與 Java 完全相同）
- 首次登入自動建立帳號
- 帳號上線 / 離線狀態追蹤
- 斷線自動清理（自動登出）

### Character System（角色系統）
- 角色建立（7 職業：王族、騎士、妖精、法師、黑暗妖精、龍騎士、幻術師）
- 官方基礎能力值與 HP / MP 成長
- 角色清單顯示
- 角色選擇與進入遊戲（17+ 初始化封包）
- 角色座標追蹤與斷線存檔

### Multiplayer（多人系統）
- 共用世界狀態（玩家可互相看到）
- 即時移動廣播（S_MOVECHARPACKET）
- 區域聊天系統
- 玩家外觀封包（S_CHARPACK）
- 玩家離線即時從其他玩家畫面移除

### World System（世界系統）
- 32x32 區塊式空間分割
- O(k) 可視範圍查詢（取代 O(n) 全體掃描）
- 支援 V1（文字）與 V2（二進位壓縮）地圖格式
- 地圖通行判定、安全區 / 戰鬥區判定

### Game Engine（遊戲引擎）
- Tick-based AI 引擎（單一主循環處理所有 NPC）
- NPC 睡眠優化（附近無玩家時跳過 AI）
- 戰鬥計算（命中 / 閃避 / 傷害 / 暴擊）
- NPC 生成系統（由資料庫載入）

### Siege System（攻城系統，官方資料）
- 8 座城堡（戰爭區域、守護塔、內城地圖）
- 戰爭狀態機（宣戰 → 進行中 → 勝利 / 超時）
- 城門系統（6 階段損壞 + 破壞）
- 守護塔（4 階段裂痕，亞丁副塔邏輯）
- 守護塔破壞後生成王冠
- 投石機系統（僅傷害玩家，10 秒冷卻）
- 城堡守衛（官方 HP，資料來源 Bahamut Wiki）
- 攻城 Buff：王族守護（攻擊力 +30）
- 黑騎士 NPC 駐守城門

### Skill System（技能系統）
- 7 職業完整技能樹（官方資料）
- 技能施放引擎（MP / INT 減免）
- Buff / Debuff 系統（Tick 到期）
- 技能冷卻追蹤
- 魔法抗性計算
- Buff 傷害加成整合戰鬥系統

### Item System（道具系統）
- 道具模板（Etc / 武器 / 防具）由 MySQL 載入
- 背包管理（可堆疊 / 不可堆疊）
- 裝備欄位系統
- 封包支援：S_AddItem、S_DeleteItem、S_InvList、S_ItemStatus

### Vulcan Forge System（火神鍛造系統，官方）
- 裝備熔煉 → 火神結晶（官方數值）
- 火神契約 + 結晶製作
- 火神之鎚成功率加成
- 官方配方資料（武官之刃、克特之劍、宙斯巨劍等）

### Teleport System（傳送系統）
- 地下城入口資料表（MySQL）
- 記憶座標 CRUD
- 傳送動畫與地圖切換
- C_ENTERPORTAL、C_BOOKMARK、C_BOOKMARKDELETE 處理

### Clan System（血盟系統）
- 血盟 CRUD（clan_data / clan_members）
- 10 階級制度
- 建立 / 加入 / 離開 / 踢人
- 宣戰封包
- 城主王冠顯示
- 血盟徽章支援

---

## 效能表現（Release）

| 項目 | 結果 |
|----|----|
| 生成 10,000 NPC | 4.49 ms |
| Tick 10,000 NPC | 平均 0.478 ms / 最大 0.735 ms |
| Tick 預算使用率 | 0.37% |
| 理論 NPC 上限 | 約 270,000 |
| 10,000 次可視查詢 | 58.8 ms（5.88 μs / 次） |

---

## 測試結果
- 102 個單元測試
- 2 個壓力測試
- 全數通過

---

## 環境需求
- Rust 1.70+（測試於 1.93.0）
- MySQL 8.0+
- 天堂 1 客戶端（3.80c 台灣版）

---

## 授權
本專案僅供教育與研究用途。
